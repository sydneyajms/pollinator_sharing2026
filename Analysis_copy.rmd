---
title: "Analysis1"
output: html_document
date: "2026-01-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(dplyr)
library(bipartite)
library(ggplot2)
library(cluster)
library(vegan)
```

```{r}
# read in cleaned data
pollinators <- read.csv("Pollinator_data_cleaned.csv")
seeds <- read.csv("Cleaned_seeds.csv")

# get unique treatments from seed data and make into empty list
trts <- unique(seeds$genSpec)
clist <- vector(mode='list', length=length(trts)) #list of communities (treatments)
names(clist) <- trts  #naming the parts of the list the name of the treatment group 

# create for loop to make each item in list contain block and plots from that treatment
for (tt in trts){
  tmp <- seeds[seeds$genSpec==tt,]
  plot <- unique(tmp$Plot)
  block <- unique(tmp$Block)

# create adjacency matrix for each item in list (community) 
  polls <- pollinators[pollinators$Block %in% block & pollinators$Plot %in% plot,]
  ppmat <- as.matrix(table(polls$sp, polls$Genus))
  clist[[tt]] <- ppmat
}

#whole experiment network:
pp_all <- as.matrix(table(pollinators$sp, pollinators$Genus))
```

analyse data 

```{r}

# find network and group level characteristics 
H_values <- lapply(clist, networklevel, index = "H2")
niche_overlap <- lapply(clist, grouplevel, level ="both", index = "niche overlap")
generality <- lapply(clist, grouplevel, level = "both", index = "mean number of shared partners")

# convert list of metrics to data frame (can use for all metrics calculated)
Hdf <- as.data.frame(H_values)
nichedf <- as.data.frame(niche_overlap)
generaldf <- as.data.frame(generality)

# rearrange data frames
nichedf_long <- nichedf %>% 
  tibble::rownames_to_column("group") %>% 
  pivot_longer(cols = -group, names_to = "treatment", values_to = "overlap")
generaldf_long <- generaldf %>% 
  tibble::rownames_to_column("group") %>% 
  pivot_longer(cols = -group, names_to = "treatment", values_to = "num_shared_partners")

# rename to specifiy which overlap is which 
nichedf_long$group[nichedf_long$group == "niche.overlap.HL"] <- "pollinators" 
nichedf_long$group[nichedf_long$group == "niche.overlap.LL"] <- "plants" 
generaldf_long$group[generaldf_long$group == "mean.number.of.shared.partners.HL"] <- "pollinators" 
generaldf_long$group[generaldf_long$group == "mean.number.of.shared.partners.LL"] <- "plants" 

# join group level characterisics
group_leveldf <- inner_join(nichedf_long, generaldf_long, by = c("group", "treatment"))
```

Begin whole network Analysis

```{r}

# visualise network as heatmap
library(RColorBrewer)
cols <- hcl.colors(20, "Peach", rev = TRUE)
#par(mfrow =c(2,3))
lapply(clist, visweb, square = "defined", box.col = "black", def.col = cols, labsize = 0.5, text = "interaction", textcol = "black", NA.col = "white")

# make overlap models
lapply(clist, plotweb)

# cols <- hcl.colors(51, "Peach", rev=TRUE)
# intermax <- max(unlist(clist)) # flattens list of matrices and finds highest interaction number
# par(mfrow=c(2,3), mar=c(1,1,1,1), bty='n')
# for (i in trts){
#   Opolls <- order(colSums(clist[[i]]), decreasing=TRUE)
#   Oplants <- order(rowSums(clist[[i]]), decreasing=FALSE)
#   tmp <- clist[[i]][Oplants, Opolls]
#   image(t(tmp), zlim=c(0, intermax), col=cols, asp=1) 
# }
```

Seed analysis and joining together to analyse

```{r}
# find average Closed - Open per plant per group 
seedsGrouped <- seeds %>%
  mutate(poll_impact = CsPerb -OsPerb) %>%
  group_by(genSpec, sp) %>%
  summarise(seedsPerPlant = mean(poll_impact))
 # mutate(plantStand = paste(genSpec, sp, sep = "_")) # collect treatment and plant toegther 

# split into species
focalSeeds <- seedsGrouped %>%
  pivot_wider(names_from = genSpec, values_from = seedsPerPlant)

# want to make non negative ?
logseeds <- seedsGrouped %>%
  mutate(logseedsPerPlant = log10(seedsPerPlant))
```

